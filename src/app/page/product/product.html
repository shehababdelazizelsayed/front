<div class="min-vh-100" style="background: linear-gradient(to bottom, var(--bs-body-bg), var(--bs-secondary))">
  <app-nav></app-nav>

  <main class="container" style="padding-top: 120px; padding-bottom: 80px">
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div *ngIf="error" class="alert alert-danger" role="alert">
      {{ error }}
    </div>

    <div class="row g-4" [class.opacity-50]="loading">
      <div class="col-lg-5">
        <div class="card shadow-lg border">
          <div class="card-body p-3">
            <img [src]="book?.image" class="img-fluid rounded" [alt]="book?.title" *ngIf="book?.image; else noImage" />
            <ng-template #noImage>
              <div class="text-center p-5 bg-light rounded">
                <i class="bi bi-image fs-1 text-muted"></i>
                <p class="mt-2 mb-0 text-muted">No image available</p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card shadow-lg border mb-4">
          <div class="card-body">
            <h1 class="display-5 fw-bold mb-3">{{ book?.title || 'Loading...' }}</h1>
            <p class="fs-4 text-primary mb-2">${{ book?.price || '0' }}</p>
            <p class="fs-5 mb-4">by {{ book?.author || 'Unknown Author' }}</p>

            <div class="mb-4">
              <span class="badge bg-primary me-2">{{ book?.Category || 'Uncategorized' }}</span>
            </div>

            <p class="fs-5 text-muted-custom mb-4">
              {{ book?.description || 'No description available' }}
            </p>

            <button class="btn btn-outline-primary btn-lg" (click)="addToWishlist()">
              Add to Wishlist
            </button>
          </div>
        </div>

        <div class="card shadow-lg border">
          <div class="card-body">
            <h2 class="h4 fw-bold mb-4">Customer Reviews</h2>

            <div class="mb-4" *ngIf="isLoggedIn">
              <div class="card bg-light border-0 mb-3">
                <div class="card-body">
                  <h5 class="fw-semibold mb-3">Write a Review</h5>

                  <label class="form-label">Rating</label>
                  <select [(ngModel)]="newReview.rating" class="form-select mb-3">
                    <option [value]="5">5 Stars</option>
                    <option [value]="4">4 Stars</option>
                    <option [value]="3">3 Stars</option>
                    <option [value]="2">2 Stars</option>
                    <option [value]="1">1 Star</option>
                  </select>

                  <label class="form-label">Your Review</label>
                  <textarea [(ngModel)]="newReview.comment" class="form-control mb-3" rows="3"></textarea>

                  <button class="btn btn-primary" (click)="submitReview()">
                    Submit Review
                  </button>
                </div>
              </div>
            </div>

            <div class="d-grid gap-4" *ngIf="!loading && reviews && reviews.length > 0">
              <div *ngFor="let review of reviews" class="card bg-light border-0">
                <div class="card-body">

                  <div *ngIf="editingReviewId === review._id; else viewMode">
                    <h6 class="fw-semibold mb-2">Edit Review</h6>

                    <label class="form-label">Rating</label>
                    <select class="form-select form-select-sm mb-2" [(ngModel)]="editReviewData.rating">
                      <option [value]="5">5 Stars</option>
                      <option [value]="4">4 Stars</option>
                      <option [value]="3">3 Stars</option>
                      <option [value]="2">2 Stars</option>
                      <option [value]="1">1 Star</option>
                    </select>

                    <label class="form-label">Review</label>
                    <textarea
                      class="form-control form-control-sm"
                      rows="3"
                      [(ngModel)]="editReviewData.comment"
                    ></textarea>

                    <div class="d-flex justify-content-end gap-2 mt-2">
                      <button class="btn btn-sm btn-secondary" (click)="cancelEditReview()">Cancel</button>
                      <button class="btn btn-sm btn-primary" (click)="saveReviewEdit()">Save</button>
                    </div>
                  </div>

                  <ng-template #viewMode>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div class="text-warning">
                        <i *ngFor="let star of [].constructor(review.Rating)" class="bi bi-star-fill me-1"></i>
                        <i *ngFor="let star of [].constructor(5 - review.Rating)" class="bi bi-star text-muted me-1"></i>
                      </div>

                      <div *ngIf="canModifyReview(review)">
                        <button class="btn btn-sm btn-outline-primary me-2" (click)="startEditReview(review)">
                          Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" (click)="deleteReview(review._id)">
                          Delete
                        </button>
                      </div>
                    </div>

                    <p class="mb-1">{{ review.Review }}</p>
                    <small class="text-muted">{{ review.createdAt | date }}</small>
                  </ng-template>

                </div>
              </div>
            </div>

            <div *ngIf="reviews.length === 0" class="text-center py-4">
              <p class="text-muted mb-0">No reviews yet. Be the first to review this book!</p>
            </div>

          </div>
        </div>

      </div>
    </div>
  </main>
</div>
