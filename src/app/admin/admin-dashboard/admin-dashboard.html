<div class="container mt-5 pt-5">
  <h2 class="fw-bold mb-4 text-center text-gradient">Admin Dashboard</h2>

  <!-- Connection Status -->
  <div class="mb-3">
    <span class="badge" [ngClass]="isSocketConnected ? 'bg-success' : 'bg-danger'">
      <i class="bi" [ngClass]="isSocketConnected ? 'bi-wifi' : 'bi-wifi-off'"></i>
      {{ isSocketConnected ? 'Connected' : 'Disconnected' }}
    </span>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status"></div>
  </div>

  <!-- Stats Cards -->
  <div *ngIf="!isLoading" class="row text-center mb-4">
    <div class="col-md-4 mb-3">
      <div class="card dashboard-card border-0 p-4 shadow-lg">
        <h5 class="text-primary fw-semibold">Total Users</h5>
        <p class="fs-3 fw-bold mb-0">{{ totalUsers }}</p>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card dashboard-card border-0 p-4 shadow-lg">
        <h5 class="text-success fw-semibold">Total Books</h5>
        <p class="fs-3 fw-bold mb-0">{{ totalBooks }}</p>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card dashboard-card border-0 p-4 shadow-lg">
        <h5 class="text-warning fw-semibold">Total Orders</h5>
        <p class="fs-3 fw-bold mb-0">{{ totalOrders }}</p>
      </div>
    </div>
  </div>

  <!-- Buttons Section -->
  <div class="row g-3 justify-content-center mb-5">
    <div class="col-md-3">
      <a routerLink="/admin/users" class="btn btn-primary w-100 dashboard-btn">
        <i class="bi bi-people-fill me-2"></i> Manage Users
      </a>
    </div>
    <div class="col-md-3">
      <a routerLink="/admin/books" class="btn btn-success w-100 dashboard-btn">
        <i class="bi bi-book-half me-2"></i> Manage Books
      </a>
    </div>
    <div class="col-md-3">
      <a routerLink="/admin/orders" class="btn btn-warning w-100 dashboard-btn">
        <i class="bi bi-bag-check-fill me-2"></i> Manage Orders
      </a>
    </div>
    <div class="col-md-3">
      <button class="btn btn-info w-100 dashboard-btn" (click)="loadPendingBooks()">
        <i class="bi bi-hourglass-split me-2"></i> Pending Books ({{ pendingBooksCount }})
      </button>
    </div>
  </div>

  <!-- Pending Books Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-info p-3">
          <h5 class="mb-0 text-white">
            <i class="bi bi-hourglass-split me-2"></i>Pending Book Approvals
          </h5>
        </div>
        <div class="card-body">
          <!-- Loading Spinner -->
          <div *ngIf="isPendingLoading" class="text-center py-5">
            <div class="spinner-border text-info" role="status"></div>
            <p class="mt-2">Loading pending books...</p>
          </div>

          <!-- Empty State -->
          <div
            *ngIf="!isPendingLoading && pendingBooks.length === 0"
            class="text-center py-5 text-muted"
          >
            <i class="bi bi-check-circle" style="font-size: 3rem"></i>
            <p class="mt-3">No pending books. All books have been reviewed!</p>
          </div>

          <!-- Pending Books Table -->
          <div *ngIf="!isPendingLoading && pendingBooks.length > 0" style="overflow-x: auto">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Title</th>
                  <th>Author</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Uploaded By</th>
                  <th>Date Uploaded</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let book of pendingBooks">
                  <td class="fw-semibold">{{ book.Title }}</td>
                  <td>{{ book.Author }}</td>
                  <td>
                    <span class="badge bg-secondary">{{ book.Category }}</span>
                  </td>
                  <td>${{ book.Price | number : '1.2-2' }}</td>
                  <td>{{ book.Owner?.Name || 'Unknown' }}</td>
                  <td>{{ book.createdAt | date : 'short' }}</td>
                  <td>
                    <button
                      class="btn btn-sm btn-success me-2"
                      (click)="openApprovalModal(book)"
                      title="Approve book"
                    >
                      <i class="bi bi-check-lg"></i> Approve
                    </button>
                    <button
                      class="btn btn-sm btn-danger"
                      (click)="openRejectionModal(book)"
                      title="Reject book"
                    >
                      <i class="bi bi-x-lg"></i> Reject
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Approval Modal -->
  <div
    class="modal"
    [ngClass]="{ 'show d-block': showApprovalModal }"
    style="background-color: rgba(0, 0, 0, 0.5)"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Approve Book</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModals()"></button>
        </div>
        <div class="modal-body">
          <p *ngIf="selectedPendingBook">
            Are you sure you want to approve "<strong>{{ selectedPendingBook.Title }}</strong
            >" by <strong>{{ selectedPendingBook.Author }}</strong
            >?
          </p>
          <p class="text-muted">
            This book will be transferred to the main collection and become visible to all users.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
          <button type="button" class="btn btn-success" (click)="approvePendingBook()">
            Approve
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rejection Modal -->
  <div
    class="modal"
    [ngClass]="{ 'show d-block': showRejectionModal }"
    style="background-color: rgba(0, 0, 0, 0.5)"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Reject Book</h5>
          <button type="button" class="btn-close btn-close-white" (click)="closeModals()"></button>
        </div>
        <div class="modal-body">
          <p *ngIf="selectedPendingBook">
            Rejecting "<strong>{{ selectedPendingBook.Title }}</strong
            >" by
            <strong>{{ selectedPendingBook.Author }}</strong>
          </p>
          <label for="rejectionReason" class="form-label">Reason for Rejection:</label>
          <textarea
            id="rejectionReason"
            class="form-control"
            rows="4"
            placeholder="Please provide a reason for rejecting this book..."
            [(ngModel)]="rejectionReason"
          ></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
          <button type="button" class="btn btn-danger" (click)="rejectPendingBook()">Reject</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Real-time Notifications Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-lg">
        <div class="card-header bg-gradient p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-bell-fill me-2"></i>Real-time Activity</h5>
            <button
              *ngIf="notifications.length > 0"
              class="btn btn-sm btn-outline-danger"
              (click)="clearNotifications()"
            >
              Clear All
            </button>
          </div>
        </div>
        <div class="card-body" style="max-height: 500px; overflow-y: auto">
          <!-- Empty State -->
          <div *ngIf="notifications.length === 0" class="text-center py-5 text-muted">
            <i class="bi bi-inbox" style="font-size: 3rem"></i>
            <p class="mt-3">No activity yet. New orders and books will appear here.</p>
          </div>

          <!-- Notifications List -->
          <div
            *ngFor="let notification of notifications; let i = index"
            class="notification-item mb-3 pb-3 border-bottom"
          >
            <div class="d-flex justify-content-between align-items-start">
              <div class="d-flex align-items-start" style="flex: 1">
                <!-- Notification Icon -->
                <div class="me-3">
                  <span [ngClass]="getNotificationBadgeClass(notification.type)">
                    <i [ngClass]="getNotificationIcon(notification.type)"></i>
                  </span>
                </div>

                <!-- Notification Content -->
                <div style="flex: 1">
                  <p class="mb-1 fw-semibold">
                    <span *ngIf="notification.type === 'order'">
                      <i class="bi bi-bag-check-fill text-success me-2"></i>New Order
                    </span>
                    <span *ngIf="notification.type === 'book'">
                      <i class="bi bi-book-half text-info me-2"></i>New Book Added
                    </span>
                  </p>
                  <p class="mb-2 text-dark">{{ notification.message }}</p>

                  <!-- Order Details -->
                  <div
                    *ngIf="notification.type === 'order' && notification.data"
                    class="small text-muted"
                  >
                    <p class="mb-1"><strong>Order ID:</strong> {{ notification.data.userId }}</p>
                    <p class="mb-1">
                      <strong>Total:</strong> ${{ notification.data.total | number : '1.2-2' }}
                    </p>
                    <p class="mb-0"><strong>Items:</strong> {{ notification.data.itemCount }}</p>
                  </div>

                  <!-- Book Details -->
                  <div
                    *ngIf="notification.type === 'book' && notification.data"
                    class="small text-muted"
                  >
                    <p class="mb-1"><strong>Title:</strong> {{ notification.title }}</p>
                    <p class="mb-1"><strong>Author:</strong> {{ notification.data.author }}</p>
                    <p class="mb-1"><strong>Category:</strong> {{ notification.data.category }}</p>
                    <p class="mb-1">
                      <strong>Price:</strong> ${{ notification.data.price | number : '1.2-2' }}
                    </p>
                    <p class="mb-0"><strong>Stock:</strong> {{ notification.data.stock }}</p>
                  </div>

                  <!-- Timestamp -->
                  <small class="text-muted d-block mt-2">
                    {{ notification.timestamp | date : 'short' }}
                  </small>
                </div>
              </div>

              <!-- Remove Button -->
              <button
                class="btn btn-sm btn-close ms-2"
                (click)="removeNotification(i)"
                title="Remove notification"
              ></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .notification-item {
    transition: all 0.3s ease;
  }

  .notification-item:hover {
    background-color: #f8f9fa;
    border-radius: 4px;
  }

  .dashboard-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
  }
</style>
